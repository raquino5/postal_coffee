<h1 class="mb-3">Search Products</h1>

<div class="d-flex justify-content-between align-items-center mb-3">
  <%= link_to "Back to Products",
        products_path,
        class: "btn btn-secondary" %>

  <%= link_to "View Cart (#{cart_count})",
        cart_path,
        class: "btn btn-outline-secondary" %>
</div>

<div class="card mb-4">
  <%= form_with url: search_products_path,
                method: :get,
                local: true do %>
    <div class="row g-3 align-items-end">
      <div class="col-md-5">
        <%= label_tag :q, "Keyword", class: "form-label" %>
        <%= text_field_tag :q,
              @query,
              placeholder: "Search by name or description",
              class: "form-control" %>
      </div>

      <div class="col-md-4">
        <%= label_tag :category_id, "Category", class: "form-label" %>
        <%= select_tag :category_id,
              options_for_select(
                [["All categories", ""]] + @categories.map { |c| [c.name, c.id] },
                @selected_category_id
              ),
              include_blank: false,
              class: "form-select" %>
      </div>

      <div class="col-md-3">
        <%= submit_tag "Search",
              class: "btn btn-primary mt-2 mt-md-0" %>
      </div>
    </div>
  <% end %>
</div>

<% if @products.any? %>
  <p class="mb-3">
    Showing <%= @products.count %> result(s)
    <% if @query.present? %>
      for "<strong><%= @query %></strong>"
    <% end %>
    <% if @selected_category_id.present? %>
      in category
      "<strong><%= @categories.find(@selected_category_id).name rescue 'Unknown' %></strong>"
    <% end %>
  </p>

  <div class="product-grid">
    <% @products.each do |product| %>
      <div class="card product-card">
        <% if product.image.attached? %>
          <div class="product-image">
            <%= image_tag url_for(product.image), class: "img-fluid" %>
          </div>
        <% end %>

        <h2 class="product-name">
          <%= link_to product.name,
                product_path(product),
                class: "product-name-link" %>
        </h2>

        <p class="product-meta">
          <strong>Category:</strong> <%= product.category.name %>
        </p>

        <p class="product-price">
          <strong>Price:</strong>
          $<%= "%.2f" % product.price %>
        </p>

        <div class="product-badges">
          <% if product.on_sale? %>
            <span class="badge badge-sale">On Sale</span>
          <% end %>

          <% if product.created_at >= 3.days.ago %>
            <span class="badge badge-new">New</span>
          <% elsif product.updated_at >= 3.days.ago && product.created_at < 3.days.ago %>
            <span class="badge badge-updated">Recently updated</span>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="pagination-wrapper">
    <%= paginate @products %>
  </div>
<% else %>
  <p>No products found. Try a different keyword or category.</p>
<% end %>
